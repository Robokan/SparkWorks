# SparkWorks â€” Isaac Sim 5.1.0 Container
#
# Base image: NVIDIA Isaac Sim 5.1.0 (Kit 107.3.3)
# Adds: build123d (Open Cascade Python bindings) for parametric CAD modeling
#
# The template variables ($KIT_FILE_NAME_BREADCRUMB, $KIT_ARGS_BREADCRUMB) are
# replaced by the repo_kit_template packaging tool when building a fat package.
# For development, use docker-compose.dev.yml instead.

FROM nvcr.io/nvidia/isaac-sim:5.1.0

# Switch to root to install system deps and pip packages
USER root

# Install system dependencies needed by Open Cascade / build123d
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        curl \
        libgl1 \
        libglib2.0-0 \
        libxrender1 \
        libxext6 \
    && apt-get -y autoremove \
    && apt-get clean autoclean \
    && rm -rf /var/lib/apt/lists/*

# Install build123d (pulls in cadquery-ocp / Open Cascade bindings automatically)
# Using the Kit-bundled Python to ensure compatibility
RUN /isaac-sim/python.sh -m pip install --no-cache-dir \
        build123d \
        numpy

# Copy the staged fat package into /app (for packaged deployment)
COPY --chown=root:root --chmod=555 package /app/

# Copy the container entrypoint script
COPY --chown=root:root --chmod=555 entrypoint.sh /entrypoint.sh

# Create StreamSDK extended timeout config file
RUN mkdir -p /isaac-sim/.config
COPY --chown=root:root --chmod=555 stream_sdk.txt /isaac-sim/.config/regkeys.txt

# Switch back to the Isaac Sim rootless user (UID 1234)
USER 1234
WORKDIR /isaac-sim

# Label for discovering kit_app_template built images within the docker registry.
LABEL kit_app_template=$KIT_FILE_NAME_BREADCRUMB

# Open ports for live streaming
EXPOSE 47995-48012/udp \
       47995-48012/tcp \
       49000-49007/udp \
       49000-49007/tcp \
       8011/tcp \
       8111/tcp \
       49100/tcp

# This specifies the container's default entrypoint that will be called by "> docker run".
ENTRYPOINT [ "/entrypoint.sh" ]