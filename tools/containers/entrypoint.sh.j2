#!/usr/bin/env bash
set -e
set -u

# Entrypoint for the Parametric CAD / Isaac Sim 5.1 container.
# Adapted for the isaac-sim:5.1.0 base image which runs as UID 1234
# with home at /isaac-sim/.

write_omniverse_toml() {
  local bookmark_name=$$1
  local bookmark_value=$$2
  mkdir --parents /isaac-sim/.nvidia-omniverse/config
  cat <<EOF > /isaac-sim/.nvidia-omniverse/config/omniverse.toml
[bookmarks]
"$${bookmark_name}" = "$${bookmark_value}"
EOF
}

USER_ID="$${USER_ID:-""}"
if [ -z "$${USER_ID}" ]; then
  echo "User id is not set"
fi

# If NVDA_KIT_NUCLEUS is set, write out the omniverse.toml value
if [ -n "$${NVDA_KIT_NUCLEUS:-}" ]; then
  write_omniverse_toml "$${NVDA_KIT_BOOKMARK_NAME:-$${NVDA_KIT_NUCLEUS}}" "$${NVDA_KIT_BOOKMARK_VALUE:-omniverse://$${NVDA_KIT_NUCLEUS}}"
  nucleus_cmd="--/ovc/nucleus/server=$${NVDA_KIT_NUCLEUS}"
fi

# Use the Isaac Sim kit binary
CMD="/isaac-sim/kit/kit"
ARGS=(
"/isaac-sim/apps/$KIT_FILE_NAME_BREADCRUMB"
$KIT_ARGS_BREADCRUMB
$${NVDA_KIT_ARGS:-""}
$${nucleus_cmd:-""}
)

# Emit the .kit file to be executed if kit_verbose is set
if [ $${OM_KIT_VERBOSE:-0} = "1" ]; then
  export KIT_FILE=/isaac-sim/apps/$KIT_FILE_NAME_BREADCRUMB
  echo "==== Print out kit config $${KIT_FILE} for debugging ===="
  cat $${KIT_FILE}
  echo "==== End of kit config $${KIT_FILE} ===="
fi

echo "Starting Kit with $$CMD $${ARGS[@]} $$@"

eval "$$CMD" "$${ARGS[@]}" "$$@"
